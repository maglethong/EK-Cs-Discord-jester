name: CD

on:
  push:
    branches: [ "master", "feature/finish-cd-pipeline" ]

env:
  KEY_VAULT_NAME: "kv-ek-discord"
  RELEASE_STORAGE_ACCOUNT_NAME: "dtekdiscterraformsa"
  RELEASE_STORAGE_ACCOUNT_CONTAINER_NAME: "publicreleases"
  RESOURCE_GROUP_NAME: "rg-ek"
  DEPLOY_VM_NAME: "mv-myvm"
  
jobs:
  build:
    
    # Available runner types: https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: ubuntu-22.04  

    steps:

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      
#    - name: Connect to Azure Key Vault
#      uses: Azure/get-keyvault-secrets@v1
#      with:
#        keyvault: $KEY_VAULT_NAME
#        secrets: 'Discord--Token, Notion--Token'
#      id: myGetSecretAction
      
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    - name: Build the Docker image
      run: >
        docker build 
        --file Dockerfile 
        --tag maglethong/ek/discord/jester:${{ github.sha }}
        .

    - name: Export docker image
      run: >
        docker image save 
        --output ./DockerImage.tar
        maglethong/ek/discord/jester:${{ github.sha }}

      # TODO Put code in a .ps1 file since it's getting kinda hard to read it here
    - name: Upload image to Azure storage account
      shell: pwsh
      id: upload
      run: |
        $imageFile = "./DockerImage.tar"
        $storageAccountName = $env:RELEASE_STORAGE_ACCOUNT_NAME
        $storageContainerName = $env:RELEASE_STORAGE_ACCOUNT_CONTAINER_NAME
        $targetFileName = "./DockerImage-${{ github.sha }}.tar"
        Write-Host Uploading release to $targetFileName
        az storage blob upload --file $imageFile --name $targetFileName --account-name $storageAccountName --container-name $storageContainerName --auth-mode login --timeout 300
      
#  https://learn:
#    microsoft:
#      com/en-us/azure/virtual-machines/linux/run-command-managed:
#  $PublicParametersArray = @([Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='publicParam1';value='publicParam1value'},
#  >> [Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='publicParam2';value='publicParam2value'})
#  
#  $ProtectedParametersArray = @([Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='secret1';value='secret1value'},
#  >> [Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='secret2';value='secret2value'})
#  
#  Set-AzVMRunCommand -ResourceGroupName MyRG0 -VMName MyVMEE -RunCommandName MyRunCommand -Location EastUS2EUAP -SourceScriptUri <SourceScriptUri> -Parameter $PublicParametersArray -ProtectedParameter $ProtectedParametersArray

    - name: Deploy to VM
      shell: pwsh
      run: |
        $storageAccountName = $env:RELEASE_STORAGE_ACCOUNT_NAME
        $storageContainerName = $env:RELEASE_STORAGE_ACCOUNT_CONTAINER_NAME
        $resource_group_name = $env:RESOURCE_GROUP_NAME
        $vm_name = $env:DEPLOY_VM_NAME
        $key_vault_name = $env:KEY_VAULT_NAME
        $subscription = ((az account list | ConvertFrom-Json) | WHERE isDefault -eq $true).id
        $tenant = ((az account list | ConvertFrom-Json) | WHERE isDefault -eq $true).tenantId
        $deployStorageUrl="https://${storageAccountName}.blob.core.windows.net/${storageContainerName}/"
        $targetFileName = "./DockerImage-${{ github.sha }}.tar"
        az vm run-command invoke `
          --resource-group $resource_group_name `
          --name $vm_name `
          --command-id "SetupVm" `
          --scripts "./.github/workflows/Deploy.sh >> Deploy.log" `
          --parameters "$deployStorageUrl" `
                       "${{ github.sha }}" `
                       "${{ secrets.AZURE_CREDENTIALS }}"

    - name: Cleanup Storage
      shell: pwsh
      if: ${{ steps.upload.conclusion == 'success' }}
      run: |
        $storageAccountName = $env:RELEASE_STORAGE_ACCOUNT_NAME
        $storageContainerName = $env:RELEASE_STORAGE_ACCOUNT_CONTAINER_NAME
        $existingReleasesRaw = az storage blob list --account-name $storageAccountName --container-name $storageContainerName --auth-mode login --timeout 300
        $toDeleteList = ($existingReleasesRaw | ConvertFrom-Json | Sort-Object $_.properties.lastModified) | Select-Object -Property name
        foreach ($fileToDelete in $toDeleteList) {
          Write-Host Deleting old release file: $fileToDelete.Name
          az storage blob delete --name $fileToDelete.Name --account-name $storageAccountName --container-name $storageContainerName --auth-mode login --timeout 300
        }
        
    - name: Azure Logout (Relevant on Self Hosted Runners)
      if: always()
      run: az logout
